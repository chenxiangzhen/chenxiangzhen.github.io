
# ä½¿ç”¨Neo4jåˆ†æã€ŠæƒåŠ›çš„æ¸¸æˆã€‹
å‡ ä¸ªæœˆå‰ï¼Œæ•°å­¦å®¶ Andrew Beveridgeå’ŒJie Shanåœ¨æ•°å­¦æ‚å¿—ä¸Šå‘è¡¨ã€ŠæƒåŠ›çš„ç½‘ç»œã€‹ï¼Œä¸»è¦åˆ†æç•…é”€å°è¯´ã€Šå†°ä¸ç«ä¹‹æ­Œã€‹ç¬¬ä¸‰éƒ¨ã€Šå†°é›¨çš„é£æš´ã€‹ä¸­äººç‰©å…³ç³»ï¼Œå…¶å·²ç»æ‹æˆç”µè§†å‰§ã€ŠæƒåŠ›çš„æ¸¸æˆã€‹ç³»åˆ—ã€‚ä»–ä»¬åœ¨è®ºæ–‡ä¸­ä»‹ç»äº†å¦‚ä½•é€šè¿‡æ–‡æœ¬åˆ†æå’Œå®ä½“æå–æ„å»ºäººç‰©å…³ç³»çš„ç½‘ç»œã€‚ç´§æ¥ç€ï¼Œä½¿ç”¨ç¤¾äº¤ç½‘ç»œåˆ†æç®—æ³•å¯¹äººç‰©å…³ç³»ç½‘ç»œåˆ†ææ‰¾å‡ºæœ€é‡è¦çš„è§’è‰²ï¼›åº”ç”¨ç¤¾åŒºå‘ç°ç®—æ³•æ¥æ‰¾åˆ°äººç‰©èšç±»ã€‚


```python
#! pip install py2neo
from py2neo import Graph
graph = Graph()
```

å®‰è£…py2neo


```python
!pip install py2neo --upgrade
```

    Collecting py2neo
      Downloading py2neo-3.1.0-py2.py3-none-any.whl (140kB)
    [K    100% |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 143kB 3.0MB/s 
    [?25hInstalling collected packages: py2neo
      Found existing installation: py2neo 2.0.8
        Uninstalling py2neo-2.0.8:
          Successfully uninstalled py2neo-2.0.8
    Successfully installed py2neo-3.1.0
    

## Import into Neo4j
é¦–å…ˆåˆ›å»ºèŠ‚ç‚¹cï¼Œå¹¶åšå”¯ä¸€é™åˆ¶æ€§çº¦æŸï¼Œc.nameå”¯ä¸€ï¼Œä¿è¯schemaçš„å®Œæ•´æ€§ï¼š

å¸¦æœ‰æ ‡ç­¾Characterçš„èŠ‚ç‚¹ä»£è¡¨å°è¯´ä¸­çš„è§’è‰²ï¼Œç”¨å•å‘å…³ç³»ç±»å‹INTERACTSä»£è¡¨å°è¯´ä¸­çš„è§’è‰²æœ‰è¿‡æ¥è§¦ã€‚èŠ‚ç‚¹å±æ€§ä¼šå­˜å‚¨è§’è‰²çš„åå­—nameï¼Œä¸¤è§’è‰²é—´æ¥è§¦çš„æ¬¡æ•°ä½œä¸ºå…³ç³»çš„å±æ€§ï¼šæƒé‡ï¼ˆweightï¼‰ã€‚

ä¸€æ—¦çº¦æŸåˆ›å»ºå³ç›¸åº”çš„åˆ›å»ºç´¢å¼•ï¼Œè¿™å°†æœ‰åŠ©äºé€šè¿‡è§’è‰²çš„åå­—æŸ¥è¯¢çš„æ€§èƒ½ã€‚ä½œè€…ä½¿ç”¨Neo4jçš„Cypherï¼ˆCypheræ˜¯ä¸€ç§å£°æ˜å¼å›¾æŸ¥è¯¢è¯­è¨€ï¼Œèƒ½è¡¨è¾¾é«˜æ•ˆæŸ¥è¯¢å’Œæ›´æ–°å›¾æ•°æ®åº“ï¼‰LOAD CSVè¯­å¥å¯¼å…¥æ•°æ®ï¼š


```python
# åˆ›å»ºèŠ‚ç‚¹ï¼Œå¹¶å”¯ä¸€æ€§çº¦æŸ
graph.run("CREATE CONSTRAINT ON (c:Character) ASSERT c.name IS UNIQUE;")

# å¯¼å…¥èŠ‚ç‚¹ï¼Œå…³ç³»å’Œå…³ç³»çš„å±æ€§
for record in graph.run('''
LOAD CSV WITH HEADERS FROM "https://www.macalester.edu/~abeverid/data/stormofswords.csv" AS row
MERGE (src:Character {name: row.Source})
MERGE (tgt:Character {name: row.Target})
MERGE (src)-[r:INTERACTS]->(tgt)
SET r.weight = toInt(row.Weight)
RETURN count(*) AS paths_written
'''):
    print(record)
```

    ('paths_written': 352)
    


```python
# match
for r in graph.run('''
MATCH p=(:Character)-[:INTERACTS]-(:Character)
RETURN p limit 10
'''):
    print(r)
```

    <Record p=(Aemon)-[:INTERACTS {weight: 31}]->(Samwell)>
    <Record p=(Aemon)<-[:INTERACTS {weight: 4}]-(Stannis)>
    <Record p=(Aemon)-[:INTERACTS {weight: 5}]->(Grenn)>
    <Record p=(Aemon)<-[:INTERACTS {weight: 4}]-(Robert)>
    <Record p=(Aemon)<-[:INTERACTS {weight: 30}]-(Jon)>
    <Record p=(Aerys)-[:INTERACTS {weight: 8}]->(Tywin)>
    <Record p=(Aerys)-[:INTERACTS {weight: 5}]->(Tyrion)>
    <Record p=(Aerys)-[:INTERACTS {weight: 18}]->(Jaime)>
    <Record p=(Aerys)-[:INTERACTS {weight: 6}]->(Robert)>
    <Record p=(Alliser)<-[:INTERACTS {weight: 15}]-(Jon)>
    

![](http://www.lyonwj.com/public/img/got-graph-full.png)

## Analyzing the network åˆ†æç½‘ç»œ

### Number of characters äººç‰©æ•°é‡
ä¸‡äº‹ä»¥ç®€å•å¼€å§‹ã€‚å…ˆçœ‹çœ‹ä¸Šå›¾ä¸Šç”±æœ‰å¤šå°‘äººç‰©ï¼š


```python
# count
for record in graph.run("MATCH (c:Character) RETURN count(c) AS num"):
    print(record)
```

    <Record num=107>
    

### Summary statistics æ¦‚è¦ç»Ÿè®¡
ç»Ÿè®¡æ¯ä¸ªè§’è‰²æ¥è§¦çš„å…¶å®ƒè§’è‰²çš„æ•°ç›®ï¼š


```python
# with min max avg stdev
for record in graph.run('''
MATCH (c:Character)-[:INTERACTS]->()
WITH c, count(*) AS num
RETURN min(num) AS min, max(num) AS max, avg(num) AS avg_characters, stdev(num) AS stdev
'''):
    print(record)
```

    <Record min=1 max=24 avg_characters=4.957746478873241 stdev=6.2276723918750845>
    

### Diameter of the network ç½‘ç»œç›´å¾„
ç½‘ç»œçš„ç›´å¾„æˆ–è€…æµ‹åº•çº¿æˆ–è€…æœ€é•¿æœ€çŸ­è·¯å¾„


```python
for r in graph.run('''
// Find maximum diameter of network
// maximum shortest path between two nodes
MATCH (a:Character), (b:Character) WHERE id(a) > id(b)
MATCH p=shortestPath((a)-[:INTERACTS*]-(b))
RETURN length(p) AS len, extract(x IN nodes(p) | x.name) AS path
ORDER BY len DESC LIMIT 4
'''):
    print(r)
```

    ('len': 6, 'path': ['Illyrio', 'Belwas', 'Daenerys', 'Robert', 'Tywin', 'Oberyn', 'Amory'])
    ('len': 6, 'path': ['Illyrio', 'Belwas', 'Daenerys', 'Robert', 'Sansa', 'Bran', 'Jojen'])
    ('len': 6, 'path': ['Illyrio', 'Belwas', 'Daenerys', 'Robert', 'Stannis', 'Davos', 'Shireen'])
    ('len': 6, 'path': ['Illyrio', 'Belwas', 'Daenerys', 'Robert', 'Sansa', 'Bran', 'Luwin'])
    

æˆ‘ä»¬èƒ½çœ‹åˆ°ç½‘ç»œä¸­æœ‰è®¸å¤šé•¿åº¦ä¸º6çš„è·¯å¾„ã€‚
### Shortest path æœ€çŸ­è·¯å¾„
ä½¿ç”¨Cypher çš„shortestPathå‡½æ•°æ‰¾åˆ°å›¾ä¸­ä»»æ„ä¸¤ä¸ªè§’è‰²ä¹‹é—´çš„æœ€çŸ­è·¯å¾„ã€‚è®©æˆ‘ä»¬æ‰¾å‡ºå‡¯ç‰¹ç³Â·å²å¡”å…‹ï¼ˆCatelyn Stark ï¼‰å’Œå“æˆˆÂ·å¡å¥¥ï¼ˆKahl Drogoï¼‰ä¹‹é—´çš„æœ€çŸ­è·¯å¾„ï¼š


```python
for r in graph.run('''
// Shortest path from Catelyn Stark to Khal Drogo
MATCH (catelyn:Character {name: "Catelyn"}), (drogo:Character {name: "Drogo"})
MATCH p=shortestPath((catelyn)-[INTERACTS*]-(drogo))
RETURN p
'''):
    print(r)
```

    <Record p=(Catelyn)-[:INTERACTS {weight: 8}]->(Sansa)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    

![](http://www.lyonwj.com/public/img/shortestpath-got.png)

### All shortest paths æ‰€æœ‰çš„æœ€çŸ­è·¯å¾„
è”ç»“å‡¯ç‰¹ç³Â·å²å¡”å…‹ï¼ˆCatelyn Stark ï¼‰å’Œå“æˆˆÂ·å¡å¥¥ï¼ˆKahl Drogoï¼‰ä¹‹é—´çš„æœ€çŸ­è·¯å¾„å¯èƒ½è¿˜æœ‰å…¶å®ƒè·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Cypherçš„allShortestPathså‡½æ•°æ¥æŸ¥æ‰¾ï¼š


```python
for r in graph.run('''
// All shortest paths from Catelyn Stark to Khal Drogo
MATCH (catelyn:Character {name: "Catelyn"}), (drogo:Character {name: "Drogo"})
MATCH p=allShortestPaths((catelyn)-[INTERACTS*]-(drogo))
RETURN p
'''):
    print(r)
```

    <Record p=(Catelyn)-[:INTERACTS {weight: 8}]->(Sansa)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 19}]->(Jaime)-[:INTERACTS {weight: 4}]->(Barristan)<-[:INTERACTS {weight: 11}]-(Jorah)-[:INTERACTS {weight: 6}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 19}]->(Jaime)-[:INTERACTS {weight: 4}]->(Barristan)<-[:INTERACTS {weight: 20}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 19}]->(Jaime)-[:INTERACTS {weight: 17}]->(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 4}]->(Cersei)-[:INTERACTS {weight: 16}]->(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 4}]->(Stannis)<-[:INTERACTS {weight: 5}]-(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 5}]->(Tyrion)<-[:INTERACTS {weight: 4}]-(Viserys)<-[:INTERACTS {weight: 8}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)-[:INTERACTS {weight: 5}]->(Tyrion)-[:INTERACTS {weight: 9}]->(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    <Record p=(Catelyn)<-[:INTERACTS {weight: 5}]-(Eddard)-[:INTERACTS {weight: 10}]->(Robert)<-[:INTERACTS {weight: 5}]-(Daenerys)-[:INTERACTS {weight: 18}]->(Drogo)>
    

![](http://www.lyonwj.com/public/img/allshortestpaths-got.png)

### Pivotal nodes å…³é”®èŠ‚ç‚¹
åœ¨ç½‘ç»œä¸­ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä½äºå…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹æ‰€æœ‰çš„æœ€çŸ­è·¯å¾„ä¸Šï¼Œå³ç§°ä¸ºå…³é”®èŠ‚ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬æ‰¾å‡ºç½‘ç»œä¸­æ‰€æœ‰çš„å…³é”®èŠ‚ç‚¹ï¼š


```python
for r in graph.run('''
// Find all pivotal nodes in network
MATCH (a:Character), (b:Character)
MATCH p=allShortestPaths((a)-[:INTERACTS*]-(b)) 
WITH collect(p) AS paths, a, b
MATCH (c:Character) WHERE all(x IN paths WHERE c IN nodes(x)) AND NOT c IN [a,b]
RETURN a.name, b.name, c.name AS PivotalNode SKIP 490 LIMIT 10
'''):
    print(r)
```

    <Record a.name='Balon' b.name='Lothar' PivotalNode='Robb'>
    <Record a.name='Balon' b.name='Luwin' PivotalNode='Bran'>
    <Record a.name='Balon' b.name='Luwin' PivotalNode='Robb'>
    <Record a.name='Balon' b.name='Melisandre' PivotalNode='Stannis'>
    <Record a.name='Balon' b.name='Missandei' PivotalNode='Daenerys'>
    <Record a.name='Balon' b.name='Myrcella' PivotalNode='Tyrion'>
    <Record a.name='Balon' b.name='Rattleshirt' PivotalNode='Jon'>
    <Record a.name='Balon' b.name='Rickard' PivotalNode='Robb'>
    <Record a.name='Balon' b.name='Rickon' PivotalNode='Robb'>
    <Record a.name='Balon' b.name='Roose' PivotalNode='Robb'>
    

ä»ç»“æœè¡¨æ ¼ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæœ‰è¶£çš„ç»“æœï¼šç½—æŸÂ·å²å¡”å…‹ï¼ˆRobbï¼‰æ˜¯å“æˆˆÂ·å¡å¥¥ï¼ˆDrogoï¼‰å’Œæ‹‰å§†å¡Â·æ³¢é¡¿ï¼ˆRamsayï¼‰çš„å…³é”®èŠ‚ç‚¹ã€‚è¿™æ„å‘³ç€ï¼Œæ‰€æœ‰è”ç»“å“æˆˆÂ·å¡å¥¥ï¼ˆDrogoï¼‰å’Œæ‹‰å§†å¡Â·æ³¢é¡¿ï¼ˆRamsayï¼‰çš„æœ€çŸ­è·¯å¾„éƒ½è¦ç»è¿‡ç½—æŸÂ·å²å¡”å…‹ï¼ˆRobbï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯è§†åŒ–å“æˆˆÂ·å¡å¥¥ï¼ˆDrogoï¼‰å’Œæ‹‰å§†å¡Â·æ³¢é¡¿ï¼ˆRamsayï¼‰ä¹‹é—´çš„æ‰€æœ‰æœ€çŸ­è·¯å¾„æ¥éªŒè¯ï¼š


```python
for r in graph.run('''
MATCH (a:Character {name: "Drogo"}), (b:Character {name: "Ramsay"})
MATCH p=allShortestPaths((a)-[:INTERACTS*]-(b))
RETURN p
'''):
    print(r)
```

    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 5}]-(Sansa)<-[:INTERACTS {weight: 15}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 6}]-(Jorah)-[:INTERACTS {weight: 11}]->(Barristan)<-[:INTERACTS {weight: 4}]-(Jaime)<-[:INTERACTS {weight: 15}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 20}]->(Barristan)<-[:INTERACTS {weight: 4}]-(Jaime)<-[:INTERACTS {weight: 15}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 17}]-(Jaime)<-[:INTERACTS {weight: 15}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)-[:INTERACTS {weight: 5}]->(Stannis)<-[:INTERACTS {weight: 4}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 8}]->(Viserys)-[:INTERACTS {weight: 4}]->(Tyrion)<-[:INTERACTS {weight: 12}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 9}]-(Tyrion)<-[:INTERACTS {weight: 12}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 5}]-(Jon)<-[:INTERACTS {weight: 14}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 11}]-(Tywin)<-[:INTERACTS {weight: 12}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 10}]-(Eddard)-[:INTERACTS {weight: 13}]->(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    <Record p=(Drogo)<-[:INTERACTS {weight: 18}]-(Daenerys)-[:INTERACTS {weight: 5}]->(Robert)<-[:INTERACTS {weight: 4}]-(Arya)<-[:INTERACTS {weight: 15}]-(Robb)-[:INTERACTS {weight: 4}]->(Ramsay)>
    

![](http://www.lyonwj.com/public/img/pivotal-path.png)

## Centrality measures ä¸­å¿ƒåº¦åº¦é‡
ç»™å‡ºç½‘ç»œä¸­èŠ‚ç‚¹çš„é‡è¦æ€§çš„ç›¸å¯¹åº¦é‡ã€‚æœ‰è®¸å¤šä¸åŒçš„æ–¹å¼æ¥åº¦é‡ä¸­å¿ƒåº¦ï¼Œæ¯ç§æ–¹å¼éƒ½ä»£è¡¨ä¸åŒç±»å‹çš„â€œé‡è¦æ€§â€ã€‚

### Degree centrality åº¦ä¸­å¿ƒæ€§
åº¦ä¸­å¿ƒæ€§æ˜¯æœ€ç®€å•åº¦é‡ï¼Œå³ä¸ºæŸä¸ªèŠ‚ç‚¹åœ¨ç½‘ç»œä¸­çš„è”ç»“æ•°ã€‚åœ¨ã€ŠæƒåŠ›çš„æ¸¸æˆã€‹çš„å›¾ä¸­ï¼ŒæŸä¸ªè§’è‰²çš„åº¦ä¸­å¿ƒæ€§æ˜¯æŒ‡è¯¥è§’è‰²æ¥è§¦çš„å…¶ä»–è§’è‰²æ•°ã€‚ä½œè€…ä½¿ç”¨Cypherè®¡ç®—åº¦ä¸­å¿ƒæ€§ï¼š


```python
for r in graph.run('''
MATCH (c:Character)-[:INTERACTS]-()
RETURN c.name AS character, count(*) AS degree ORDER BY degree DESC LIMIT 10
'''):
    print(r)
```

    <Record character='Tyrion' degree=36>
    <Record character='Sansa' degree=26>
    <Record character='Jon' degree=26>
    <Record character='Robb' degree=25>
    <Record character='Jaime' degree=24>
    <Record character='Tywin' degree=22>
    <Record character='Cersei' degree=20>
    <Record character='Arya' degree=19>
    <Record character='Catelyn' degree=18>
    <Record character='Joffrey' degree=18>
    

ä»ä¸Šé¢å¯ä»¥å‘ç°ï¼Œåœ¨ã€ŠæƒåŠ›çš„æ¸¸æˆã€‹ç½‘ç»œä¸­æåˆ©æ˜‚Â·å…°å°¼æ–¯ç‰¹ï¼ˆTyrionï¼‰å’Œæœ€å¤šçš„è§’è‰²æœ‰æ¥è§¦ã€‚é‰´äºä»–çš„å¿ƒè®¡ï¼Œæˆ‘ä»¬è§‰å¾—è¿™æ˜¯æœ‰é“ç†çš„ã€‚
### Weighted degree centrality åŠ æƒåº¦ä¸­å¿ƒæ€§
ä½œè€…å­˜å‚¨ä¸€å¯¹è§’è‰²æ¥è§¦çš„æ¬¡æ•°ä½œä¸ºINTERACTSå…³ç³»çš„weightå±æ€§ã€‚å¯¹è¯¥è§’è‰²çš„INTERACTSå…³ç³»çš„æ‰€æœ‰weightç›¸åŠ å¾—åˆ°åŠ æƒåº¦ä¸­å¿ƒæ€§ã€‚ä½œè€…ä½¿ç”¨Cypherè®¡ç®—æ‰€æœ‰è§’è‰²çš„è¿™ä¸ªåº¦é‡ï¼š


```python
for r in graph.run('''
MATCH (c:Character)-[r:INTERACTS]-()
RETURN c.name AS character, sum(r.weight) AS weightedDegree ORDER BY weightedDegree DESC LIMIT 10
'''):
    print(r)
```

    <Record character='Tyrion' weightedDegree=551>
    <Record character='Jon' weightedDegree=442>
    <Record character='Sansa' weightedDegree=383>
    <Record character='Jaime' weightedDegree=372>
    <Record character='Bran' weightedDegree=344>
    <Record character='Robb' weightedDegree=342>
    <Record character='Samwell' weightedDegree=282>
    <Record character='Arya' weightedDegree=269>
    <Record character='Joffrey' weightedDegree=255>
    <Record character='Daenerys' weightedDegree=232>
    

### Betweenness centrality ä»‹æ•°ä¸­å¿ƒæ€§
ä»‹æ•°ä¸­å¿ƒæ€§ï¼šåœ¨ç½‘ç»œä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„ä»‹æ•°ä¸­å¿ƒæ€§æ˜¯æŒ‡å…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰æœ€çŸ­è·¯å¾„éƒ½ç»è¿‡è¿™ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è¿™äº›æ‰€æœ‰æœ€çŸ­è·¯å¾„æ•°å³ä¸ºæ­¤èŠ‚ç‚¹çš„ä»‹æ•°ä¸­å¿ƒæ€§ã€‚ä»‹æ•°ä¸­å¿ƒæ€§æ˜¯ä¸€ç§é‡è¦çš„åº¦é‡ï¼Œå› ä¸ºå®ƒå¯ä»¥é‰´åˆ«å‡ºç½‘ç»œä¸­çš„â€œä¿¡æ¯ä¸­é—´äººâ€æˆ–è€…ç½‘ç»œèšç±»åçš„è”ç»“ç‚¹ã€‚


```python
for r in graph.run('''
CALL algo.betweenness.stream('Character')
YIELD nodeId, centrality
MATCH (c:Character) WHERE id(c) = nodeId
RETURN c.name AS c,centrality
ORDER BY centrality DESC limit 10;
'''):
    print(r)
```

    <Record c='Tyrion' centrality=332.97460317460315>
    <Record c='Samwell' centrality=244.6357142857143>
    <Record c='Stannis' centrality=226.20476190476188>
    <Record c='Robert' centrality=208.62301587301593>
    <Record c='Mance' centrality=138.66666666666669>
    <Record c='Jaime' centrality=119.99563492063493>
    <Record c='Sandor' centrality=114.33333333333333>
    <Record c='Jon' centrality=111.26666666666667>
    <Record c='Janos' centrality=90.65>
    <Record c='Aemon' centrality=64.59761904761905>
    

### Closeness centrality ç´§åº¦ä¸­å¿ƒæ€§
ç´§åº¦ä¸­å¿ƒæ€§æ˜¯æŒ‡åˆ°ç½‘ç»œä¸­æ‰€æœ‰å…¶ä»–è§’è‰²çš„å¹³å‡è·ç¦»çš„å€’æ•°ã€‚åœ¨å›¾ä¸­ï¼Œå…·æœ‰é«˜ç´§åº¦ä¸­å¿ƒæ€§çš„èŠ‚ç‚¹åœ¨èšç±»ç¤¾åŒºä¹‹é—´è¢«é«˜åº¦è”ç»“ï¼Œä½†åœ¨ç¤¾åŒºä¹‹å¤–ä¸ä¸€å®šæ˜¯é«˜åº¦è”ç»“çš„ã€‚


```python
cql = '''CALL algo.closeness.stream('Character', 'INTERACTS')
YIELD nodeId, centrality
MATCH (c:Character) WHERE id(c) = nodeId
RETURN c.name AS c,centrality
ORDER BY centrality DESC limit 10;'''
for r in graph.run(cql):
    print(r)
```

    <Record c='Tyrion' centrality=0.5120772946859904>
    <Record c='Sansa' centrality=0.5096153846153846>
    <Record c='Robert' centrality=0.5>
    <Record c='Robb' centrality=0.48847926267281105>
    <Record c='Arya' centrality=0.48623853211009177>
    <Record c='Jon' centrality=0.4796380090497738>
    <Record c='Jaime' centrality=0.4796380090497738>
    <Record c='Stannis' centrality=0.4796380090497738>
    <Record c='Tywin' centrality=0.4690265486725664>
    <Record c='Eddard' centrality=0.4608695652173913>
    

## Using python-igraph ä½¿ç”¨python-igraph
Neo4jä¸å…¶å®ƒå·¥å…·ï¼ˆæ¯”å¦‚ï¼ŒRå’ŒPythonæ•°æ®ç§‘å­¦å·¥å…·ï¼‰å®Œç¾ç»“åˆã€‚æˆ‘ä»¬ç»§ç»­ä½¿ç”¨apocè¿è¡Œ PageRankå’Œç¤¾åŒºå‘ç°ï¼ˆcommunity detectionï¼‰ç®—æ³•ã€‚è¿™é‡Œæ¥ç€ä½¿ç”¨python-igraphè®¡ç®—åˆ†æã€‚Python-igraphç§»æ¤è‡ªRçš„igraphå›¾å½¢åˆ†æåº“ã€‚ ä½¿ç”¨pip install python-igraphå®‰è£…å®ƒã€‚

### Building an igraph instance from Neo4j æ„å»ºä¸€ä¸ªigraphå®ä¾‹
ä¸ºäº†åœ¨ã€ŠæƒåŠ›çš„æ¸¸æˆã€‹çš„æ•°æ®çš„å›¾åˆ†æä¸­ä½¿ç”¨igraphï¼Œé¦–å…ˆéœ€è¦ä»Neo4jæ‹‰å–æ•°æ®ï¼Œç”¨Pythonå»ºç«‹igraphå®ä¾‹ã€‚ä½œè€…ä½¿ç”¨ Neo4j çš„Pythoné©±åŠ¨åº“py2neoã€‚æˆ‘ä»¬èƒ½ç›´æ¥ä¼ å…¥Py2neoæŸ¥è¯¢ç»“æœå¯¹è±¡åˆ°igraphçš„TupleListæ„é€ å™¨ï¼Œåˆ›å»ºigraphå®ä¾‹ï¼š


```python
#! pip install python-igraph
from igraph import Graph as IGraph

query = '''
MATCH (c1:Character)-[r:INTERACTS]->(c2:Character)
RETURN c1.name, c2.name, r.weight AS weight
'''
# ä»å…ƒç»„åˆ—è¡¨è¡¨ç¤ºå½¢å¼æ„é€ ä¸€ä¸ªå›¾
ig = IGraph.TupleList(graph.run(query), weights=True)

ig
```




    <igraph.Graph at 0x2089631d68>



ç°åœ¨æœ‰äº†igraphå¯¹è±¡ï¼Œå¯ä»¥è¿è¡Œigraphå®ç°çš„å„ç§å›¾ç®—æ³•äº†ã€‚

## PageRank
PageRankç®—æ³•æºè‡ªGoogleçš„ç½‘é¡µæ’åã€‚å®ƒæ˜¯ä¸€ç§ç‰¹å¾å‘é‡ä¸­å¿ƒæ€§(eigenvector centrality)ç®—æ³•ã€‚

åœ¨igraphå®ä¾‹ä¸­è¿è¡ŒPageRankç®—æ³•ï¼Œç„¶åæŠŠç»“æœå†™å›Neo4jï¼Œåœ¨è§’è‰²èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªpagerankå±æ€§å­˜å‚¨igraphè®¡ç®—çš„å€¼ï¼š

### PageRank

![](http://www.lyonwj.com/public/img/page-rank.png)




```python
# Calculates the Google PageRank values of a graph.
pg = ig.pagerank()

pgvs = []
# ig.vs:å›¾çš„é¡¶ç‚¹åºåˆ—
for p in zip(ig.vs, pg):
    pgvs.append({"name": p[0]["name"], "pg": p[1]})
print(pgvs[:5])

write_clusters_query = '''
UNWIND {nodes} AS n
MATCH (c:Character) WHERE c.name = n.name
SET c.pagerank = n.pg
'''

graph.run(write_clusters_query, nodes=pgvs)
```

    [{'name': 'Stannis', 'pg': 0.018020131765195593}, {'name': 'Aemon', 'pg': 0.007328980991947571}, {'name': 'Robert', 'pg': 0.022292016521362857}, {'name': 'Jon', 'pg': 0.035828696691635555}, {'name': 'Alliser', 'pg': 0.005162125869510499}]
    




    <py2neo.database.Cursor at 0x208962d7f0>



ç°åœ¨å¯ä»¥åœ¨Neo4jçš„å›¾ä¸­æŸ¥è¯¢æœ€é«˜PageRankå€¼çš„èŠ‚ç‚¹ï¼š


```python
for r in graph.run('''
MATCH (n:Character)
RETURN n.name AS name, n.pagerank AS pagerank ORDER BY pagerank DESC LIMIT 10
'''):
    print(r)
```

    ('name': 'Tyrion', 'pagerank': 0.042884981999963316)
    ('name': 'Jon', 'pagerank': 0.03582869669163558)
    ('name': 'Robb', 'pagerank': 0.03017114665594764)
    ('name': 'Sansa', 'pagerank': 0.030009716660108578)
    ('name': 'Daenerys', 'pagerank': 0.02881425425830273)
    ('name': 'Jaime', 'pagerank': 0.028727587587471206)
    ('name': 'Tywin', 'pagerank': 0.02570016262642541)
    ('name': 'Robert', 'pagerank': 0.022292016521362864)
    ('name': 'Cersei', 'pagerank': 0.022287327589773507)
    ('name': 'Arya', 'pagerank': 0.022050209663844467)
    

### Community detection

![](http://www.lyonwj.com/public/img/community-1.png)

ç¤¾åŒºå‘ç°ç®—æ³•ç”¨æ¥æ‰¾å‡ºå›¾ä¸­çš„ç¤¾åŒºèšç±»ã€‚ä½œè€…ä½¿ç”¨igraphå®ç°çš„éšæœºæ¸¸èµ°ç®—æ³•ï¼ˆ walktrapï¼‰æ¥æ‰¾åˆ°åœ¨ç¤¾åŒºä¸­é¢‘ç¹æœ‰æ¥è§¦çš„è§’è‰²ç¤¾åŒºï¼Œåœ¨ç¤¾åŒºä¹‹å¤–è§’è‰²ä¸æ€ä¹ˆæ¥è§¦ã€‚

åœ¨igraphä¸­è¿è¡Œéšæœºæ¸¸èµ°çš„ç¤¾åŒºå‘ç°ç®—æ³•ï¼Œç„¶åæŠŠç¤¾åŒºå‘ç°çš„ç»“æœå¯¼å…¥Neo4jï¼Œå…¶ä¸­æ¯ä¸ªè§’è‰²æ‰€å±çš„ç¤¾åŒºç”¨ä¸€ä¸ªæ•´æ•°æ¥è¡¨ç¤ºï¼š


```python
clusters = IGraph.community_walktrap(ig, weights="weight").as_clustering()

nodes = [{"name": node["name"]} for node in ig.vs]
for node in nodes:
    idx = ig.vs.find(name=node["name"]).index
    node["community"] = clusters.membership[idx]

print(nodes[:5])

write_clusters_query = '''
UNWIND {nodes} AS n
MATCH (c:Character) WHERE c.name = n.name
SET c.community = toInt(n.community)
'''

graph.run(write_clusters_query, nodes=nodes)
```

    [{'name': 'Stannis', 'community': 0}, {'name': 'Aemon', 'community': 1}, {'name': 'Robert', 'community': 2}, {'name': 'Jon', 'community': 1}, {'name': 'Alliser', 'community': 1}]
    




    <py2neo.database.Cursor at 0x208962ae48>



æˆ‘ä»¬èƒ½åœ¨Neo4jä¸­æŸ¥è¯¢æœ‰å¤šå°‘ä¸ªç¤¾åŒºä»¥åŠæ¯ä¸ªç¤¾åŒºçš„æˆå‘˜æ•°ï¼š


```python
for r in graph.run('''
MATCH (c:Character)
WITH c.community AS cluster, collect(c.name) AS  members
RETURN cluster, members ORDER BY cluster ASC
'''):
    print(r)
```

    <Record cluster=0 members=['Davos', 'Melisandre', 'Shireen', 'Stannis', 'Cressen', 'Salladhor']>
    <Record cluster=1 members=['Aemon', 'Alliser', 'Craster', 'Eddison', 'Gilly', 'Janos', 'Jon', 'Mance', 'Rattleshirt', 'Samwell', 'Val', 'Ygritte', 'Grenn', 'Karl', 'Bowen', 'Dalla', 'Orell', 'Qhorin', 'Styr']>
    <Record cluster=2 members=['Aerys', 'Amory', 'Balon', 'Brienne', 'Bronn', 'Cersei', 'Gregor', 'Jaime', 'Joffrey', 'Jon Arryn', 'Kevan', 'Loras', 'Lysa', 'Meryn', 'Myrcella', 'Oberyn', 'Podrick', 'Renly', 'Robert', 'Robert Arryn', 'Sansa', 'Shae', 'Tommen', 'Tyrion', 'Tywin', 'Varys', 'Walton', 'Petyr', 'Elia', 'Ilyn', 'Pycelle', 'Qyburn', 'Margaery', 'Olenna', 'Marillion', 'Ellaria', 'Mace', 'Chataya', 'Doran']>
    <Record cluster=3 members=['Arya', 'Beric', 'Eddard', 'Gendry', 'Sandor', 'Anguy', 'Thoros']>
    <Record cluster=4 members=['Brynden', 'Catelyn', 'Edmure', 'Hoster', 'Lothar', 'Rickard', 'Robb', 'Roose', 'Walder', 'Jeyne', 'Roslin', 'Ramsay']>
    <Record cluster=5 members=['Belwas', 'Daario', 'Daenerys', 'Irri', 'Jorah', 'Missandei', 'Rhaegar', 'Viserys', 'Barristan', 'Illyrio', 'Drogo', 'Aegon', 'Kraznys', 'Rakharo', 'Worm']>
    <Record cluster=6 members=['Bran', 'Hodor', 'Jojen', 'Luwin', 'Meera', 'Rickon', 'Nan', 'Theon']>
    <Record cluster=7 members=['Lancel']>
    

## Visualization

![](http://www.lyonwj.com/public/img/graph-of-thrones.png)

See [neovis.js](https://github.com/johnymontana/neovis.js)
